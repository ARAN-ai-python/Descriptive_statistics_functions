# n_way_ANOVA
## 概要
以前からインターンにてクラスカル=ウォリス検定を用いた分析を行ったり、一元配置分散分析をdescribes関数に実装する等、分散分析自体は知っていました。  
この度実験計画法を勉強する内に二元配置以上の分散分析にも興味が湧き、プログラミングにて自動化することを考えました。  
(自分の調べた限りだと)二元配置以上の分散分析には使いやすいライブラリがなく、describes関数と棲み分けられる内容である事も相まって、Pythonにて実装に至りました。

## リファレンス
一応読めば使える様に善処しましたが、分からなければそれぞれの関数のファイルに記述されているテストケースを見て真似ることで使用できると思います。

### 一元配置分散分析(one_way_ANOVA)
- 因子が１つの時に用いる。
- データの母集団が正規分布に従うことを仮定する。
- 水準毎にサンプルサイズが異なっていても構わない。
- 有意差があった場合は「その因子に効果がある」事が言える。(どの水準に効果があるかは分からない)
  - 帰無仮説：各水準の平均値が等しい
  - 対立仮説：各水準の平均値が異なる

#### 使い方
<img width="860" alt="スクリーンショット 2022-03-03 22 01 04" src="https://user-images.githubusercontent.com/67265109/156570064-bf68a074-2cf7-42e5-8e46-39d54cad45bf.png">

1. 因子Bをカラムに設定し、それぞれの水準毎に一列ずつデータを入れたデータフレームを作成する。ある水準が他の水準よりもサンプルサイズが小さい場合、その水準のデータの足りない行はNaNで埋めておく。(上記の例では、それぞれcolumn0,column1,column2が水準である。)
2. 分散分析表と効果表と予測値表を代入する変数を用意し、作成したデータフレームをそのまま引数に入れ、関数を実行する。
3. 1つ目の返り値である分散分析表から分析結果を読み取る。(signカラムは有意水準1%で有意である因子に「**」、有意水準5%で有意である因子に「*」で印をつけている。)
4. 分散分析の結果に応じて、2つ目の返り値である効果表から読み取った各水準の効果を活用する。
5. 各水準毎の取得データの予測値が知りたい場合、3つ目の返り値である予測値表から読み取る。


### 二元配置分散分析(繰返し無)(two_way_ANOVA)
- 因子が２つの時に用いる。
- データの母集団が正規分布に従うことを仮定する。
- 有意差があった場合は「その因子に効果がある」事が言える。(どの水準に効果があるかは分からない)
  - 帰無仮説：各水準の平均値が等しい
  - 対立仮説：各水準の平均値が異なる
- 注意：確実に交互作用が無いと言い切れる場合以外は、通常繰返し有で実験・分析を行う必要があるとされている。

#### 使い方
<img width="981" alt="スクリーンショット 2022-03-03 22 27 43" src="https://user-images.githubusercontent.com/67265109/156574173-2c5789d7-4a2c-4467-b643-fa269f8927e6.png">

1. 因子Aをインデックスに、因子Bをカラムに設定し、それぞれの水準毎に一つずつデータを入れたデータフレームを作成する。(上記の例では、因子Aの水準がindex0,index1、因子Bの水準がcolumn0,column1,column2である。)
2. 分散分析表と効果表と予測値表を代入する変数を用意し、作成したデータフレームをそのまま引数に入れ、関数を実行する。
3. 1つ目の返り値である分散分析表から分析結果を読み取る。(signカラムは有意水準1%で有意である因子に「**」、有意水準5%で有意である因子に「*」で印をつけている。)
4. 分散分析の結果に応じて、2つ目の返り値である効果表から読み取った各水準の効果を活用する。
5. 各水準毎の取得データの予測値が知りたい場合、3つ目の返り値である予測値表から読み取る。


### 二元配置分散分析(繰返し有)(two_way_factorial_ANOVA)
- 因子が２つの時かつ２因子の交互作用を考慮する際に用いる。
- データの母集団が正規分布に従うことを仮定する。
- 有意差があった場合は「その因子に効果がある」事が言える。(どの水準に効果があるかは分からない)
  - 帰無仮説：各水準の平均値が等しい
  - 対立仮説：各水準の平均値が異なる

#### 使い方
<img width="979" alt="スクリーンショット 2022-03-03 22 28 17" src="https://user-images.githubusercontent.com/67265109/156574207-d0366fbd-4dea-4eaf-ab2b-1f031d432fbc.png">

1. 因子Aをインデックスに、因子Bをカラムに設定し、それぞれの水準毎に一つずつデータを入れたデータフレームを作成する。(上記の例では、因子Aの水準がindex0,index1、因子Bの水準がcolumn0,column1,column2である。)
2. 1.で行った前処理を、繰返しの数だけ行う。(上記の例では、繰返し数が２回なので２個のデータフレームを作成している。)
3. 分散分析表と効果表と予測値表を代入する変数を用意し、作成したデータフレームをリストとしてまとめて引数に入れ、関数を実行する。
4. 1つ目の返り値である分散分析表から分析結果を読み取る。(signカラムは有意水準1%で有意である因子に「**」、有意水準5%で有意である因子に「*」で印をつけている。)
5. 分散分析の結果に応じて、2つ目の返り値である効果表から読み取った各水準の効果を活用する。
6. 各水準毎の取得データの予測値が知りたい場合、3つ目の返り値である予測値表から読み取る。


### 三元配置分散分析(繰返し無)(three_way_ANOVA)
- 因子が３つの時に用いる。
- データの母集団が正規分布に従うことを仮定する。
- 有意差があった場合は「その因子に効果がある」事が言える。(どの水準に効果があるかは分からない)
  - 帰無仮説：各水準の平均値が等しい
  - 対立仮説：各水準の平均値が異なる
- 注意：確実に交互作用が無いと言い切れる場合以外は、通常繰返し有で実験・分析を行う必要があるとされている。

#### 使い方
<img width="244" alt="スクリーンショット 2022-03-03 22 30 07" src="https://user-images.githubusercontent.com/67265109/156574496-1d2d4304-0159-4510-b1ec-374a25ae7394.png">
<img width="987" alt="スクリーンショット 2022-03-03 22 30 26" src="https://user-images.githubusercontent.com/67265109/156574506-73b81201-89fc-483a-b0bd-182620f4287c.png">
<img width="582" alt="スクリーンショット 2022-03-03 22 30 39" src="https://user-images.githubusercontent.com/67265109/156574515-f5e702c8-9f48-4a5d-bb8a-fa1b19a6897d.png">

1. 因子Aをインデックスに、因子Bをカラムに、因子Cをテーブルとして設定し、それぞれの水準毎に一つずつデータを入れたデータフレームを作成する。(上記の例では、因子Aの水準がindex0,index1、因子Bの水準がcolumn0,column1,column2、因子Cの水準がデータフレーム１(上),データフレーム2(下)である。)
2. 分散分析表と効果表と予測値表を代入する変数を用意し、作成したデータフレームをリストとしてまとめて引数に入れ、関数を実行する。
3. 1つ目の返り値である分散分析表から分析結果を読み取る。(signカラムは有意水準1%で有意である因子に「**」、有意水準5%で有意である因子に「*」で印をつけている。)
4. 分散分析の結果に応じて、2つ目の返り値である効果表から読み取った各水準の効果を活用する。(テーブルとして分けた因子Cの効果は0,1等の数値のカラム名となっている。)
5. 各水準毎の取得データの予測値が知りたい場合、3つ目の返り値である予測値表から読み取る。(予測値表はリストになっており、因子Cの水準毎にテーブルが分かれている。)

### 三元配置分散分析(繰返し有)(three_way_factorial_ANOVA)
- 因子が３つの時かつ３因子の交互作用を考慮する際に用いる。
- データの母集団が正規分布に従うことを仮定する。
- 有意差があった場合は「その因子に効果がある」事が言える。(どの水準に効果があるかは分からない)
  - 帰無仮説：各水準の平均値が等しい
  - 対立仮説：各水準の平均値が異なる

#### 使い方
<img width="242" alt="スクリーンショット 2022-03-03 22 35 53" src="https://user-images.githubusercontent.com/67265109/156575502-8dcb45e5-45df-4de8-b065-cf38bb927d0f.png">
<img width="240" alt="スクリーンショット 2022-03-03 22 36 08" src="https://user-images.githubusercontent.com/67265109/156575521-f80995bf-56ba-49ca-b93a-c41803e6d361.png">
<img width="985" alt="スクリーンショット 2022-03-03 22 36 39" src="https://user-images.githubusercontent.com/67265109/156575537-8fd5fb16-84d7-4679-93df-be41823b3aaa.png">
<img width="535" alt="スクリーンショット 2022-03-03 22 36 54" src="https://user-images.githubusercontent.com/67265109/156575542-f71c820c-a067-450a-85d6-fe80b65e6f51.png">

1. 因子Aをインデックスに、因子Bをカラムに、因子Cをテーブルとして設定し、それぞれの水準毎に一つずつデータを入れたデータフレームを作成する。(上記の例では、因子Aの水準がindex0,index1、因子Bの水準がcolumn0,column1,column2、因子Cの水準がデータフレーム１(上),データフレーム2(下)である。)
2. 1.で行った前処理を、繰返しの数だけ行う。(上記の例では、繰返し数が２回なので４個のデータフレームを作成している。)
3. 分散分析表と効果表と予測値表を代入する変数を用意し、作成したデータフレームを繰返し毎に分けて二重リストとしてまとめて引数に入れ、関数を実行する。
4. 1つ目の返り値である分散分析表から分析結果を読み取る。(signカラムは有意水準1%で有意である因子に「**」、有意水準5%で有意である因子に「*」で印をつけている。)
5. 分散分析の結果に応じて、2つ目の返り値である効果表から読み取った各水準の効果を活用する。(テーブルとして分けた因子Cの効果は0,1等の数値のカラム名となっている。)
6. 各水準毎の取得データの予測値が知りたい場合、3つ目の返り値である予測値表から読み取る。(予測値表はリストになっており、因子Cの水準毎にテーブルが分かれている。)


### 共分散分析(ANCOVA)
- ある因子の複数水準間を検定する際、それらに影響を及ぼしている因子(共変量)の影響を除いて検定する統計的検定手法
- 理論としては重回帰分析の応用であるため、重回帰分析の仮定を満たす必要がある。
  - 目的変数の誤差が正規分布に従う。
  - 目的変数が等分散である。
  - 説明変数は互いに独立である。(=交互作用がないものとみなす)
  - 目的変数と説明変数は直線の関係で説明できる。
- 重回帰分析の仮定以外に、以下の二つの条件を満たす必要がある。
  - 全水準の回帰係数が等しい(=回帰直線の傾きが平行である)
  - 回帰係数が有意に0でない(=因子と共変量が無相関でない)
- 有意差があった場合は「その因子に効果がある」事が言える。(どの水準に効果があるかは分からない)
  - 帰無仮説：各水準の平均値が等しい
  - 対立仮説：各水準の平均値が異なる

#### 使い方
<img width="185" alt="スクリーンショット 2022-04-29 22 21 45" src="https://user-images.githubusercontent.com/67265109/165953129-501fdd0b-f4eb-4e98-adb9-ba74538084ac.png">

1. 水準を区別する条件カラムと共変量、差を調べたい因子のデータを上記データフレームのように用意する。(上記例では水準は1と2の2つある)
2. 引数dataにデータフレームを、yに目的変数を、x1に水準を、x2に共変量を入れ、関数を実行する。
3. 上記のように回帰直線の平行性・回帰直線の有意差・共分散分析のp値が出力されるので、事前に設定した有意水準を参考にして結果を解釈する。


## 参考文献
- 実験計画と分散分析のはなし―効率よい計画とデータ解析のコツ　大村平　日科技連出版社(2013/1/1)
- 図解入門 よくわかる最新実験計画法の基本と仕組み[第2版]　森田浩　秀和システム(2019/8/30)

![Unknown](https://user-images.githubusercontent.com/67265109/156580936-708a5ec3-f19e-4f46-abbb-93737990aba8.jpeg)
![Unknown-1](https://user-images.githubusercontent.com/67265109/156580949-8f291f24-a75e-413b-8f1d-10f2867a7f1d.jpeg)


